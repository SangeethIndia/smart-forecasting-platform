<div class="dashboard-container">
  <h1 class="dashboard-title">MISHAP PREDICTIONS</h1>
  <p class="dashboard-desc">Forecast future mishap volumes based on historical trends to support planning and risk mitigation.</p>

  <!-- Prediction Method label -->
  <div class="prediction-method">Prediction Method</div>
  <!-- Model selection: Standard / Advanced / Balanced -->
  <div class="model-choices" style="display:flex;gap:12px;align-items:center;margin:8px 0 14px 0;flex-wrap:wrap;">
    <label style="display:flex;align-items:center;gap:8px;padding:6px 10px;border-radius:8px;background:#f8f9fb;border:1px solid #eef2f6;">
      <input type="radio" name="modelChoice" [(ngModel)]="modelChoice" (change)="onModelChoiceChange('rf')" value="rf" />
      <span style="font-weight:600;color:#0b57d0;">Standard Prediction</span>
  <mat-icon class="info-icon" matTooltip="Uses Random Forest Model for predicting the future values" aria-label="Random Forest info">info</mat-icon>
    </label>
    <label style="display:flex;align-items:center;gap:8px;padding:6px 10px;border-radius:8px;background:#f8f9fb;border:1px solid #eef2f6;">
      <input type="radio" name="modelChoice" [(ngModel)]="modelChoice" (change)="onModelChoiceChange('gb')" value="gb" />
      <span style="font-weight:600;color:#0b57d0;">Advanced Prediction</span>
  <mat-icon class="info-icon" matTooltip="Uses Gradient Boosting Model for predicting the future values" aria-label="Gradient Boosting info">info</mat-icon>
    </label>
    <label style="display:flex;align-items:center;gap:8px;padding:6px 10px;border-radius:8px;background:#f8f9fb;border:1px solid #eef2f6;">
      <input type="radio" name="modelChoice" [(ngModel)]="modelChoice" (change)="onModelChoiceChange('weighted')" value="weighted" />
      <span style="font-weight:600;color:#0b57d0;">Balanced</span>
  <mat-icon class="info-icon" matTooltip="Combines multiple Models for stability - Use the slider icon to adjust weightages" aria-label="Weighted models info">info</mat-icon>
    </label>
    <!-- weighted slider shown only when Balanced is chosen -->
    <div *ngIf="modelChoice === 'weighted'" style="display:flex;align-items:center;gap:12px;margin-left:8px;">
      <div style="display:flex;flex-direction:column;font-size:12px;">
        <div style="font-weight:600;margin-bottom:4px;">RF weight: {{ (w_rf * 100) | number:'1.0-0' }}%</div>
        <input type="range" min="0" max="100" step="1" [(ngModel)]="w_rf_percent" (change)="onSliderChange()" style="width:220px;" />
      </div>
      <div style="font-size:12px;color:#666;">GB weight: {{ ((1 - w_rf) * 100) | number:'1.0-0' }}%</div>
    </div>
  </div>
  <!-- Second-level trend selection -->
  <div class="view-toggle" style="margin-top:12px; display:flex; gap:12px; align-items:center;">
    <label class="toggle-pill" [class.active]="trendMode === 'year'">
      <input type="radio" name="trendMode" [(ngModel)]="trendMode" (ngModelChange)="onTrendModeChange()" value="year" hidden />
      Mishap Trend by Year
  <mat-icon class="info-icon" matTooltip="Shows the trend in the mishap count changes based on historical data. Covers both 'Aviation' type and 'Ground' type data. Dotted lines denote predictions and Solid lines denote historical data" aria-label="Year trend info">info</mat-icon>
    </label>
    <label class="toggle-pill" [class.active]="trendMode === 'quarter'">
      <input type="radio" name="trendMode" [(ngModel)]="trendMode" (ngModelChange)="onTrendModeChange()" value="quarter" hidden />
      Quarterly Mishap Prediction â€“ 2026
  <mat-icon class="info-icon" matTooltip="AI-generated prediction - Number of mishaps in each quarter of 2026." aria-label="Quarterly prediction info">info</mat-icon>
    </label>
    <label class="toggle-pill" [class.active]="trendMode === 'classification'">
      <input type="radio" name="trendMode" [(ngModel)]="trendMode" (ngModelChange)="onTrendModeChange()" value="classification" hidden />
      Mishap Trend by Classification
  <span class="info-popover">
    <mat-icon class="info-icon" aria-label="Classification info">info</mat-icon>
    <div class="popover-content" [innerHTML]="classificationTooltipHtml"></div>
  </span>
    </label>
  </div>

  <!-- Auto-run enabled: selections trigger predictions; Apply button removed -->

  <!-- Chart-only results -->
  <div class="results">
    <div class="chart-panel" style="min-height:520px;">
      <!-- While loading the drill/aggregate call, reserve the chart space to
           avoid layout shifts. Show a light placeholder. -->
      <ng-container *ngIf="(facade.loading$ | async); else showChart">
        <div style="height:520px;display:flex;align-items:center;justify-content:center;color:#666;background:#fafafa;border-radius:8px;border:1px dashed rgba(0,0,0,0.04);">
          Loading details...
        </div>
      </ng-container>
      <ng-template #showChart>
        <ng-container *ngIf="facade.result$ | async as result">
          <!-- Breadcrumbs / Back for drill-down -->
          <div *ngIf="breadcrumbs.length" style="display:flex;align-items:center;gap:12px;margin-bottom:8px;">
            <button class="secondary" (click)="onBack()" style="padding:6px 12px;border-radius:6px;border:1px solid #ddd;background:#fff;">Back</button>
            <div style="font-size:14px;color:#444;display:flex;gap:6px;align-items:center;">
              <ng-container *ngFor="let b of breadcrumbs; let i = index">
                <span style="font-weight:600">{{b.label}}</span>
                <span *ngIf="i < (breadcrumbs.length - 1)" style="opacity:0.6">/</span>
              </ng-container>
            </div>
          </div>

          <app-ml-chart [data]="result.predictions" [mode]="chartModeActive" [isDrill]="isDrillActive" (drill)="onDrill($event)"></app-ml-chart>
        </ng-container>
      </ng-template>
    </div>
  </div>
</div>
