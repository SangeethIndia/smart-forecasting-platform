<div class="dashboard-container">
  <h1 class="dashboard-title">MISHAP PREDICTIONS</h1>
  <br/>
  <!-- Model selection: RF / GB / Weighted -->
  <div style="display:flex;gap:12px;align-items:center;margin-bottom:10px;">
    <label style="display:flex;align-items:center;gap:8px;">
      <input type="radio" name="modelChoice" [(ngModel)]="modelChoice" (change)="onModelChoiceChange('rf')" value="rf" />
      Use Random Forest
    </label>
    <label style="display:flex;align-items:center;gap:8px;">
      <input type="radio" name="modelChoice" [(ngModel)]="modelChoice" (change)="onModelChoiceChange('gb')" value="gb" />
      Use Gradient Boosting
    </label>
    <label style="display:flex;align-items:center;gap:8px;">
      <input type="radio" name="modelChoice" [(ngModel)]="modelChoice" (change)="onModelChoiceChange('weighted')" value="weighted" />
      Use weighted average of both
    </label>
    <!-- weighted inputs shown only when weighted is chosen -->
    <div *ngIf="modelChoice === 'weighted'" style="display:flex;gap:8px;align-items:center;margin-left:8px;">
      <label style="display:flex;flex-direction:column;font-size:12px;">
        w_rf
        <input type="number" step="0.01" min="0" max="1" [(ngModel)]="w_rf" (ngModelChange)="onWeightsChange('rf')" style="width:80px;" />
      </label>
      <label style="display:flex;flex-direction:column;font-size:12px;">
        w_gb
        <input type="number" step="0.01" min="0" max="1" [(ngModel)]="w_gb" (ngModelChange)="onWeightsChange('gb')" style="width:80px;" />
      </label>
      <div style="font-size:12px;color:#888;">Sum: {{ (w_rf + w_gb) | number:'1.2-2' }}</div>
    </div>
  </div>
  <!-- Second-level trend selection -->
  <div class="view-toggle" style="margin-top:12px; display:flex; gap:12px; align-items:center;">
    <label class="toggle-pill" [class.active]="trendMode === 'year'">
      <input type="radio" name="trendMode" [(ngModel)]="trendMode" (ngModelChange)="onTrendModeChange()" value="year" hidden />
      Mishap Trend by Year
    </label>
    <label class="toggle-pill" [class.active]="trendMode === 'quarter'">
      <input type="radio" name="trendMode" [(ngModel)]="trendMode" (ngModelChange)="onTrendModeChange()" value="quarter" hidden />
      Mishap Volume by Quarters (Quarters of the Year / Seasonal)
    </label>
    <label class="toggle-pill" [class.active]="trendMode === 'classification'">
      <input type="radio" name="trendMode" [(ngModel)]="trendMode" (ngModelChange)="onTrendModeChange()" value="classification" hidden />
      Mishap Trend - Volume / Classification
    </label>
  </div>

  <!-- Apply button to construct UI-driven payload and trigger prediction -->
  <div style="margin-top:12px;">
    <button class="primary" (click)="applyFilters()" 
      style="background:#0d6efd;color:#fff;padding:12px 22px;border-radius:8px;border:none;font-weight:700;box-shadow:0 4px 12px rgba(13,110,253,0.3);font-size:16px;">
      Apply
    </button>
  </div>

  <!-- Chart-only results -->
  <div class="results">
    <div class="chart-panel" style="min-height:520px;">
      <!-- While loading the drill/aggregate call, reserve the chart space to
           avoid layout shifts. Show a light placeholder. -->
      <ng-container *ngIf="(facade.loading$ | async); else showChart">
        <div style="height:520px;display:flex;align-items:center;justify-content:center;color:#666;background:#fafafa;border-radius:8px;border:1px dashed rgba(0,0,0,0.04);">
          Loading details...
        </div>
      </ng-container>
      <ng-template #showChart>
        <ng-container *ngIf="facade.result$ | async as result">
          <!-- Breadcrumbs / Back for drill-down -->
          <div *ngIf="breadcrumbs.length" style="display:flex;align-items:center;gap:12px;margin-bottom:8px;">
            <button class="secondary" (click)="onBack()" style="padding:6px 12px;border-radius:6px;border:1px solid #ddd;background:#fff;">Back</button>
            <div style="font-size:14px;color:#444;display:flex;gap:6px;align-items:center;">
              <ng-container *ngFor="let b of breadcrumbs; let i = index">
                <span style="font-weight:600">{{b.label}}</span>
                <span *ngIf="i < (breadcrumbs.length - 1)" style="opacity:0.6">/</span>
              </ng-container>
            </div>
          </div>

          <app-ml-chart [data]="result.predictions" [mode]="chartModeActive" [isDrill]="isDrillActive" (drill)="onDrill($event)"></app-ml-chart>
        </ng-container>
      </ng-template>
    </div>
  </div>
</div>
