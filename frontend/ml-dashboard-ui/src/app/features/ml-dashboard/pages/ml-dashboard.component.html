<div class="dashboard-container">
  <h1 class="dashboard-title">MISHAP PREDICTIONS</h1>
  <p class="dashboard-desc">Forecast future mishap volumes based on historical trends to support planning and risk mitigation.</p>

  <!-- Prediction Method label -->
  <div class="prediction-method">Prediction Method</div>
  <!-- Model selection: Standard / Advanced / Balanced -->
  <div style="display:flex;gap:12px;align-items:center;margin:8px 0 14px 0;flex-wrap:wrap;">
    <label style="display:flex;align-items:center;gap:8px;padding:6px 10px;border-radius:8px;background:#f8f9fb;border:1px solid #eef2f6;">
      <input type="radio" name="modelChoice" [(ngModel)]="modelChoice" (change)="onModelChoiceChange('rf')" value="rf" />
      <span style="font-weight:600;color:#0b57d0;">Standard Prediction</span>
      <span class="info-icon" title="Uses Random Forest Model for predicting the future values" style="margin-left:6px;cursor:help;">ℹ️</span>
    </label>
    <label style="display:flex;align-items:center;gap:8px;padding:6px 10px;border-radius:8px;background:#f8f9fb;border:1px solid #eef2f6;">
      <input type="radio" name="modelChoice" [(ngModel)]="modelChoice" (change)="onModelChoiceChange('gb')" value="gb" />
      <span style="font-weight:600;color:#0b57d0;">Advanced Prediction</span>
      <span class="info-icon" title="Uses Gradient Boosting Model for predicting the future values" style="margin-left:6px;cursor:help;">ℹ️</span>
    </label>
    <label style="display:flex;align-items:center;gap:8px;padding:6px 10px;border-radius:8px;background:#f8f9fb;border:1px solid #eef2f6;">
      <input type="radio" name="modelChoice" [(ngModel)]="modelChoice" (change)="onModelChoiceChange('weighted')" value="weighted" />
      <span style="font-weight:600;color:#0b57d0;">Balanced</span>
      <span class="info-icon" title="Combines multiple Models for stability - Use the slider icon to adjust weightages" style="margin-left:6px;cursor:help;">ℹ️</span>
    </label>
    <!-- weighted slider shown only when Balanced is chosen -->
    <div *ngIf="modelChoice === 'weighted'" style="display:flex;align-items:center;gap:12px;margin-left:8px;">
      <div style="display:flex;flex-direction:column;font-size:12px;">
        <div style="font-weight:600;margin-bottom:4px;">RF weight: {{ (w_rf * 100) | number:'1.0-0' }}%</div>
        <input type="range" min="0" max="100" step="1" [(ngModel)]="w_rf_percent" (change)="onSliderChange()" style="width:220px;" />
      </div>
      <div style="font-size:12px;color:#666;">GB weight: {{ ((1 - w_rf) * 100) | number:'1.0-0' }}%</div>
    </div>
  </div>
  <!-- Second-level trend selection -->
  <div class="view-toggle" style="margin-top:12px; display:flex; gap:12px; align-items:center;">
    <label class="toggle-pill" [class.active]="trendMode === 'year'">
      <input type="radio" name="trendMode" [(ngModel)]="trendMode" (ngModelChange)="onTrendModeChange()" value="year" hidden />
      Mishap Trend by Year
    </label>
    <label class="toggle-pill" [class.active]="trendMode === 'quarter'">
      <input type="radio" name="trendMode" [(ngModel)]="trendMode" (ngModelChange)="onTrendModeChange()" value="quarter" hidden />
      Mishap Volume by Quarters (Quarters of the Year / Seasonal)
    </label>
    <label class="toggle-pill" [class.active]="trendMode === 'classification'">
      <input type="radio" name="trendMode" [(ngModel)]="trendMode" (ngModelChange)="onTrendModeChange()" value="classification" hidden />
      Mishap Trend - Volume / Classification
    </label>
  </div>

  <!-- Auto-run enabled: selections trigger predictions; Apply button removed -->

  <!-- Chart-only results -->
  <div class="results">
    <div class="chart-panel" style="min-height:520px;">
      <!-- While loading the drill/aggregate call, reserve the chart space to
           avoid layout shifts. Show a light placeholder. -->
      <ng-container *ngIf="(facade.loading$ | async); else showChart">
        <div style="height:520px;display:flex;align-items:center;justify-content:center;color:#666;background:#fafafa;border-radius:8px;border:1px dashed rgba(0,0,0,0.04);">
          Loading details...
        </div>
      </ng-container>
      <ng-template #showChart>
        <ng-container *ngIf="facade.result$ | async as result">
          <!-- Breadcrumbs / Back for drill-down -->
          <div *ngIf="breadcrumbs.length" style="display:flex;align-items:center;gap:12px;margin-bottom:8px;">
            <button class="secondary" (click)="onBack()" style="padding:6px 12px;border-radius:6px;border:1px solid #ddd;background:#fff;">Back</button>
            <div style="font-size:14px;color:#444;display:flex;gap:6px;align-items:center;">
              <ng-container *ngFor="let b of breadcrumbs; let i = index">
                <span style="font-weight:600">{{b.label}}</span>
                <span *ngIf="i < (breadcrumbs.length - 1)" style="opacity:0.6">/</span>
              </ng-container>
            </div>
          </div>

          <app-ml-chart [data]="result.predictions" [mode]="chartModeActive" [isDrill]="isDrillActive" (drill)="onDrill($event)"></app-ml-chart>
        </ng-container>
      </ng-template>
    </div>
  </div>
</div>
